server:
  config:
    alerts:
      groups:
        - name: server
          interval: 1m
          type: vlogs 
          rules:
          - alert: system_emerg_detected
            expr: |
              RIORITY: "0"
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: emergency
            annotations:
              summary: "system_emerg_detected"
              description: "システム稼働障害が発生(カーネルパニックなど)"
          - alert: system_alert_detected
            expr: |
              RIORITY: "1"
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: alert
            annotations:
              summary: "system_emerg_detected"
              description: "対応が必要な障害が発生(ディスク破損など)"
          - alert: system_crit_detected
            expr: |
              RIORITY: "2"
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "system_emerg_detected"
              description: "重大エラーが発生(ハードウェア障害など)"
          - alert: system_err_detected
            expr: |
              RIORITY: "3"
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: error
            annotations:
              summary: "system_err_detected"
              description: "エラーが発生(サービスユニットエラーなど)"
          - alert: system_warning_detected
            expr: |
              RIORITY: "4"
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "system_warning_detected"
              description: "警告が発生(firewall block など)"
          - alert: under_voltage_detected
            expr: |
              PRIORITY: "2" AND SYSLOG_IDENTIFIER: "kernel" AND ~"Undervoltage detected" 
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "Instance {{ $labels.node }} Under-voltage detected"
              description: "電圧不足のため電源交換を実施"
          - alert: system_err
            expr: |
              level: "error" AND _RUNTIME_SCOPE: "system" 
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: error
            annotations:
              summary: "{{ $labels._HOSTNAME }}の{{$labels.systemd_unit}}ユニットでエラー発生"
              description: "{{$labels.MESSAGE}}"
          - alert: system_crit
            expr: |
              level: "crit" AND _RUNTIME_SCOPE: "system" 
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "{{$labels.host}}の{{$labels.systemd_unit}}ユニットで致命的なエラー発生"
              description: "{{$labels.MESSAGE}}"
          - alert: journal_io_error
            expr: |
              _RUNTIME_SCOPE: "system" 
              | ~"I/O error" 
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>1
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "{{ $labels._HOSTNAME }} で I/O Error が発生"
              description: "ファイルシステムをアンマウントして修復してください。"
          - alert: journal_device_offline_error
            expr: |
              _RUNTIME_SCOPE: "system" 
              | ~"device offline error"  
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>1
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "{{ $labels._HOSTNAME }} でデバイスのオフラインエラーが発生"
              description: "ディスクの損傷・接続不良などの問題の可能性がある。"
          - alert: journal_nfs_lost_lock
            expr: |
              _RUNTIME_SCOPE: "system" 
              | ~"NFS: .+: lost .+ locks" 
              | stats by (_HOSTNAME) count() as matches 
              | filter matches:>1
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "{{ $labels._HOSTNAME }} で NFS ファイルロックがロストした"
              description: "kubectl get all -A | grep <IP> で SERVICE/PVC を特定し PVC を再マウントする"
          - alert: journal_ufw_block
            expr: |
              _RUNTIME_SCOPE: "system"
              | "[UFW BLOCK]"
              | stats by (_HOSTNAME) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "journal_ufw_block"
              description: "{{ $labels._HOSTNAME }} で UFW で通信が BLOCK された"
          - alert: SshLoginFromOutsice
            expr: |
              _RUNTIME_SCOPE: "system" AND _msg:~"Accepted publickey" AND _msg:!~"192\\.168"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "外部からSSHログイン"
        - name: application
          type: vlogs 
          interval: 1m
          rules:
          - alert: remote_storage_error
            expr: |
              app_kubernetes_io_name: "prometheus" AND detected_level: "error" AND _msg:~"non-recoverable error" 
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 5m
            labels:
              severity: alert
            annotations:
              summary: "prometheus remote write error"
              description: "PrometheusのRemoteWrite周りを確認"
          - alert: oom_killer
            expr: |
              job: "journal" AND _msg:~"Memory cgroup out of memory" 
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: alert
              airflow_trigger: oom_killer
            annotations:
              summary: "Instance {{ $labels.node }} Memory cgroup out of memory"
              description: "アプリケーションがメモリ不足のためresourcesを調整する"
          - alert: unauthorized_access_detection
            expr: |
              namespace: "ingress-nginx" AND _msg:~"HTTP/[1-2]\\.[0-2]\\\"\\s4[0-9]{2}\\s" AND _msg:~"/wp-login.php"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>1
            for: 0m
            labels:
              severity: alert
            annotations:
              summary: "wordpressのログインURLにアクセス試行"
              description: "アクセス内容を確認して必要であれば該当のIPをdenyに追加"
          - alert: vault_failed_to_heartbeat_to_peer
            expr: |
              app_kubernetes_io_name: "vault" 
              |~"storage.raft: failed to heartbeat to: peer"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: alert
            annotations:
              summary: "vault で raft peers のハートビート監視で失敗"
              description: "vault を確認して raft peers を構成してください"
          - alert: pod_input_output_error
            expr: |
              app_kubernetes_io_name:!"loki" AND pod_name:~".+" AND _msg:~"input/output"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "{{ $labels.pod_name }}でI/Oエラーが発生しました"
              description: |
                {{ $labels.hostname }} のホストで発生
                {{ $labels.pod_name }} の pod を再起動してください
          - alert: minecraft_bedrock_server_user_connected
            expr: |
              namespace: "prod-minecraft" AND _msg:~"Player connected"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 5m
            labels:
              severity: info
            annotations:
              summary: "Minecraft bedrock server user connected"
          - alert: longhorn_buckup_error
            expr: |
              namespace: "longhorn-system" AND _msg:~"cannot mount nfs"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: alert
            annotations:
              summary: "longhorn-system {{ $labels.node }} cannot mount nfs"
              description: "NFSサーバの状態確認を実施"
        - name: security
          type: vlogs 
          interval: 1m
          rules:
          - alert: XMRigMiningAttempt
            expr: |
              namespace: "ingress-nginx" AND remote_addr:!~"192\\.168\\..+" AND _msg:~"mining"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "XMRig マイニングアクセスを検出"
          - alert: SQLInjectionAttempt
            expr: |
              namespace: "ingress-nginx" AND remote_addr:!~"192\\.168\\..+" AND _msg:~"UNION SELECT|DROP TABLE|OR 1=1|--|%27"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: high
            annotations:
              summary: "SQLインジェクションの可能性あり"
          - alert: WordPressScan
            expr: |
              _time:5m
              namespace:="ingress-nginx"
              AND remote_addr:!~"192\\.168\\..+"
              AND _msg:~"wp-login\\.php|xmlrpc\\.php|wp-admin"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>=5
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "WordPress ターゲットのスキャン試行"
          - alert: Log4ShellAttempt
            expr: |
              namespace: "ingress-nginx" 
              AND remote_addr:!~"192\\.168\\..+"
              AND _msg:~"\\$\\{jndi:[a-z]+://" 
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "Log4Shell 攻撃検出"
          - alert: PathTraversalAttempt
            expr: |
              namespace: "ingress-nginx" AND remote_addr:!~"192\\.168\\..+" AND _msg:~"\\.\\./|\\.\\.\\\\|%2e%2e%2f"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: high
            annotations:
              summary: "パストラバーサル試行"
          - alert: SuspiciousUserAgent
            expr: |
              namespace: "ingress-nginx" AND remote_addr:!~"192\\.168\\..+" AND _msg:~"sqlmap|nikto|XMRig|curl"
              | stats by (hostname, namespace, pod_name) count() as matches
              | filter matches:>0
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "疑わしい User-Agent を検出"
